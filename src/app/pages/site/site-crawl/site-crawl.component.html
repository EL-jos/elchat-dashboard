<!-- ===============================
 üß† Sources de connaissance IA
================================ -->

<mat-card class="mb-4 el-card-title">
    <mat-card-title>Sources de connaissance</mat-card-title>
    <mat-card-subtitle>
        G√©rez tout le contenu utilis√© par votre assistant IA
    </mat-card-subtitle>
</mat-card>

<!-- ===============================
 ‚ûï Ajouter une source
================================ -->

<h3 class="mb-2 el-title-source">Ajouter une source</h3>
<div class="el-container-sources">
    <div class="el-grid">
        <!-- üåê Crawl -->
        <mat-card class="source-card clickable">
            <mat-icon>public</mat-icon>
            <h4>Site web (Crawl)</h4>
            <p>Analyse automatique de votre site</p>
        </mat-card>
        <!-- üìÅ Upload -->
        <mat-card class="source-card clickable">
            <mat-icon>upload_file</mat-icon>
            <h4>Fichier</h4>
            <p>CSV, Word, PDF</p>
        </mat-card>
        <!-- ‚úçÔ∏è Texte -->
        <mat-card class="source-card clickable">
            <mat-icon>edit</mat-icon>
            <h4>Texte manuel</h4>
            <p>Ajout direct de contenu</p>
        </mat-card>
    </div>
</div>

<!-- ===============================
 üåê Crawl du site
================================ -->

<mat-card class="mt-4 el-card-crawl" *ngIf="overview">
    <mat-card-title>Crawl du site</mat-card-title>

    <form #siteForm="ngForm" (ngSubmit)="onSubmit(siteForm)">

        <div class="el-row">
            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>URL du site web</mat-label>
                    <input matInput name="url" [(ngModel)]="overview.site.url" required disabled>
                </mat-form-field>
            </div>

            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>Crawl depth</mat-label>
                    <input matInput type="number" name="crawl_depth" [(ngModel)]="overview.settings_crawl.crawl_depth" min="1" max="5" required value="1">
                </mat-form-field>
            </div>
        </div>

        <div class="el-row">
            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>Include pages</mat-label>
                    <textarea matInput name="include_pages" [(ngModel)]="overview.settings_crawl.include_pages"
                        placeholder="Une URL par ligne ou s√©par√©e par , ; |"></textarea>
                </mat-form-field>
            </div>

            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>Exclude pages</mat-label>
                    <textarea matInput name="exclude_pages" [(ngModel)]="overview.settings_crawl.exclude_pages"
                        placeholder="Une URL par ligne ou s√©par√©e par , ; |"></textarea>
                </mat-form-field>
            </div>
        </div>

        <div class="el-row el-row-center">
            <mat-slide-toggle [(ngModel)]="useSitemap" name="useSitemap">
                Utiliser un sitemap
            </mat-slide-toggle>

            <p-fileUpload *ngIf="useSitemap" mode="basic" chooseLabel="Choisir un sitemap (.xml)" [auto]="false"
                [customUpload]="true" chooseIcon="pi pi-upload" (onSelect)="onFileSelect($event)" accept=".xml"
                [maxFileSize]="10000000">
            </p-fileUpload>
        </div>

        <div class="mt-4">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading">
                {{ loading ? 'Crawl en cours...' : 'Lancer le crawl' }}
            </button>
        </div>

    </form>
</mat-card>


<!-- ===============================
 üìÅ Upload de fichiers
================================ -->

<mat-card class="mt-4 el-card-upload-file">
    <mat-card-title>Importer un fichier</mat-card-title>

    <p-fileUpload name="file" mode="advanced" accept=".csv,.xlsx,.xls" chooseLabel="Choisir un fichier"
        uploadLabel="Uploader" cancelLabel="Annuler" [customUpload]="true" (onSelect)="onProductFileSelect($event)">
    </p-fileUpload>

    <div class="mt-2">
        <button mat-stroked-button color="primary" (click)="downloadTemplate('csv')">
            T√©l√©charger le mod√®le CSV
        </button>
        <button mat-stroked-button color="primary" class="ml-2" (click)="downloadTemplate('xlsx')">
            T√©l√©charger le mod√®le Excel
        </button>
    </div>

    
    <!-- üëá AJOUTER √Ä PARTIR D‚ÄôICI -->
    <div *ngIf="showMapping" class="mapping-zone">
    
        <div class="mapping-group" *ngFor="let group of standardColumnGroups">
            <h3>{{ group.label }}</h3>
    
            <div class="mapping-grid">
                <div class="mapping-row" *ngFor="let col of group.columns">
                    <div class="left">
                        {{ col.label }}
                        <span *ngIf="col.required" class="required">*</span>
                    </div>
    
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-select [(ngModel)]="mapping[col.key]" (selectionChange)="onMappingChange()">
                            <mat-option [value]="null">
                                ‚Äî Non mapp√© ‚Äî
                            </mat-option>
    
                            <mat-option *ngFor="let fileCol of fileColumns" [value]="fileCol"
                                [disabled]="isColumnAlreadyUsed(fileCol, col.key)">
                                {{ fileCol }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
        </div>
    
    </div>

    <!-- Bouton upload visible uniquement si le mapping est valide -->
    <div *ngIf="isMappingValid" class="mt-2">
        <button pButton type="button" label="Uploader les produits" icon="pi pi-upload"
            class="p-button-raised p-button-success" (click)="uploadProducts()">
        </button>
    </div>


    <!-- ===============================
     üëÅÔ∏è Aper√ßu des donn√©es
    ================================ -->
    <div *ngIf="previewRows.length" class="preview-zone">
    
        <h3>Aper√ßu des donn√©es ({{ previewRows.length }} lignes)</h3>
    
        <div class="preview-table">
            <table>
                <thead>
                    <tr>
                        <th *ngFor="let col of fileColumns">{{ col }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let row of previewRows">
                        <td *ngFor="let col of fileColumns">
                            {{ row[col] }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    
    </div>

</mat-card>

<!-- ===============================
 ‚úçÔ∏è Texte manuel
================================ -->

<mat-card class="mt-4">
    <mat-card-title>Texte manuel</mat-card-title>

    <mat-form-field appearance="outline" class="w-100">
        <mat-label>Titre</mat-label>
        <input matInput placeholder="Ex: Nos coordonn√©es">
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-100">
        <mat-label>Contenu</mat-label>
        <textarea matInput rows="4" placeholder="Ex: Contactez-nous √† info@domaine.com">
    </textarea>
    </mat-form-field>

    <button mat-raised-button color="primary">
        Ajouter √† la base IA
    </button>
</mat-card>

<!-- ===============================
 üìö Sources actives
================================ -->

<mat-card class="mt-4">
    <mat-card-title>Sources actives</mat-card-title>

    <p-table [value]="[]">
        <ng-template pTemplate="header">
            <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-source>
            <tr>
                <td>{{ source.name }}</td>
                <td>{{ source.type }}</td>
                <td>
                    <p-tag severity="success" value="Actif"></p-tag>
                </td>
                <td>
                    <button pButton icon="pi pi-trash" class="p-button-text"></button>
                </td>
            </tr>
        </ng-template>
    </p-table>
</mat-card>

<!-- ===============================
 üìä Qualit√© IA
================================ -->

<mat-card class="mt-4">
    <mat-card-title>Qualit√© de la connaissance</mat-card-title>

    <p-progressBar [value]="75"></p-progressBar>
    <small>Couverture estim√©e : bonne</small>
</mat-card>