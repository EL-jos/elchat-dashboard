<!-- ===============================
üìä Qualit√© IA
================================ -->
<mat-card class="mt-4 el-knowledge-quality-card" *ngIf="overview.knowledge_quality_socre; else noKnowledgeScore">

    <!-- Progress Bar globale -->
    <div class="el-score-global" [ngClass]="{
        'kl-very-low': overview.knowledge_quality_socre.global_score <= 25,
        'kl-low': overview.knowledge_quality_socre.global_score > 25 && overview.knowledge_quality_socre.global_score <= 50,
        'kl-medium': overview.knowledge_quality_socre.global_score > 50 && overview.knowledge_quality_socre.global_score <= 70,
        'kl-good': overview.knowledge_quality_socre.global_score > 70 && overview.knowledge_quality_socre.global_score <= 85,
        'kl-excellent': overview.knowledge_quality_socre.global_score > 85
      }">
        <h2>{{ overview.knowledge_quality_socre.global_score | number:'1.0-0' }}%</h2>
    </div>

    <mat-card-title>Qualit√© de la connaissance IA</mat-card-title>
    <button mat-raised-button color="primary" (click)="launchKnowledgeAnalysis()">
        Lancer l‚Äôanalyse de la connaissance IA
    </button>

    <!-- D√©tails par composant -->
    <div class="scores-details">
        <ul>
            <li>
                <h4>{{ overview.knowledge_quality_socre.coverage_score | number:'1.0-0' }}%</h4>
                <strong>Couverture</strong>
                <p class="explanation">
                    La couverture mesure le pourcentage de chunks avec du contenu.
                    Plus elle est √©lev√©e, plus l‚ÄôIA a acc√®s √† des informations fiables et compl√®tes pour r√©pondre aux
                    visiteurs.
                </p>
            </li>
            <li>
                <h4>{{ overview.knowledge_quality_socre.data_quality_score | number:'1.0-0' }}%</h4>
                <strong>Donn√©es</strong>
                <p class="explanation">
                    La qualit√© des donn√©es indique la longueur et la pr√©cision du contenu.
                    Des donn√©es d√©taill√©es permettent √† l‚ÄôIA de formuler des r√©ponses plus compl√®tes.
                </p>
            </li>
            <li>
                <h4>{{ overview.knowledge_quality_socre.semantic_score | number:'1.0-0' }}%</h4>
                <strong>Richesse s√©mantique</strong>
                <p class="explanation">
                    Mesure la diversit√© du vocabulaire et des concepts.
                    Plus le contenu est vari√©, plus l‚ÄôIA peut comprendre et reformuler les questions.
                </p>
            </li>
            <li>
                <h4>{{ overview.knowledge_quality_socre.freshness_score | number:'1.0-0' }}%</h4>
                <strong>Fra√Æcheur</strong>
                <p class="explanation">
                    Indique le pourcentage de contenu r√©cent (30 derniers jours).
                    Plus le contenu est r√©cent, plus les r√©ponses de l‚ÄôIA seront √† jour et pertinentes.
                </p>
            </li>
        </ul>
    </div>
</mat-card>

<ng-template #noKnowledgeScore>
    <mat-card class="mt-4 el-knowledge-quality-card empty-state">
        <mat-card-title>Qualit√© de la connaissance IA</mat-card-title>

        <p class="empty-explanation">
            Cette analyse permet d‚Äô√©valuer la capacit√© de l‚ÄôIA √† r√©pondre correctement
            aux visiteurs de votre site.
            <br /><br />
            Sans score de connaissance, l‚ÄôIA se base sur des donn√©es partielles,
            ce qui peut entra√Æner des r√©ponses impr√©cises ou incompl√®tes.
        </p>

        <button mat-raised-button color="primary" (click)="launchKnowledgeAnalysis()">
            Lancer l‚Äôanalyse de la connaissance IA
        </button>
    </mat-card>
</ng-template>


<!-- ===============================
 üß† Sources de connaissance IA
================================ -->
<mat-card class="mb-4 mt-4 el-card-title">
    <mat-card-title>Sources de connaissance</mat-card-title>
    <mat-card-subtitle>
        G√©rez tout le contenu utilis√© par votre assistant IA
    </mat-card-subtitle>
</mat-card>

<!-- ===============================
 ‚ûï Ajouter une source
================================ -->
<!-- <h3 class="mb-2 el-title-source">Ajouter une source</h3> -->
<div class="el-container-sources">
    <div class="el-grid">
        <!-- üåê Crawl -->
        <mat-card class="source-card clickable" [class.active]="activeSource === 'crawl'"
            (click)="selectSource('crawl')">
            <mat-icon>public</mat-icon>
            <h4>Site web (Crawl)</h4>
            <p>Analyse automatique de votre site</p>
        </mat-card>
        <!-- üìÅ Upload -->
        <mat-card class="source-card clickable" [class.active]="activeSource === 'file'" (click)="selectSource('file')">
            <mat-icon>upload_file</mat-icon>
            <h4>Fichier</h4>
            <p>CSV, Word, PDF</p>
        </mat-card>
        <!-- ‚úçÔ∏è Texte -->
        <mat-card class="source-card clickable" [class.active]="activeSource === 'manual'"
            (click)="selectSource('manual')">
            <mat-icon>edit</mat-icon>
            <h4>Texte manuel</h4>
            <p>Ajout direct de contenu</p>
        </mat-card>
    </div>
</div>

<!-- ===============================
 üåê Crawl du site
================================ -->
<mat-card class="mt-4 el-card-crawl" *ngIf="activeSource === 'crawl' && overview">
    <mat-card-title>Crawl du site</mat-card-title>

    <form #siteForm="ngForm" (ngSubmit)="onCrawlSubmit(siteForm)">

        <div class="el-row">
            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>URL du site web</mat-label>
                    <input matInput name="url" [(ngModel)]="overview.site.url" required disabled>
                </mat-form-field>
            </div>

            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>Crawl depth</mat-label>
                    <input matInput type="number" name="crawl_depth" [(ngModel)]="overview.settings_crawl.crawl_depth"
                        min="1" max="5" required value="1">
                </mat-form-field>
            </div>
        </div>

        <div class="el-row">
            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>Include pages</mat-label>
                    <textarea matInput name="include_pages" [(ngModel)]="overview.settings_crawl.include_pages"
                        placeholder="Une URL par ligne ou s√©par√©e par , ; |"></textarea>
                </mat-form-field>
            </div>

            <div class="el-col">
                <mat-form-field appearance="outline">
                    <mat-label>Exclude pages</mat-label>
                    <textarea matInput name="exclude_pages" [(ngModel)]="overview.settings_crawl.exclude_pages"
                        placeholder="Une URL par ligne ou s√©par√©e par , ; |"></textarea>
                </mat-form-field>
            </div>
        </div>

        <div class="el-row el-row-center">
            <mat-slide-toggle [(ngModel)]="useSitemap" name="useSitemap">
                Utiliser un sitemap
            </mat-slide-toggle>

            <p-fileUpload *ngIf="useSitemap" mode="basic" chooseLabel="Choisir un sitemap (.xml)" [auto]="false"
                [customUpload]="true" chooseIcon="pi pi-upload" (onSelect)="onFileSelect($event)" accept=".xml"
                [maxFileSize]="10000000">
            </p-fileUpload>
        </div>

        <div class="mt-4">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading">
                {{ loading ? 'Crawl en cours...' : 'Lancer le crawl' }}
            </button>
        </div>

    </form>
</mat-card>
<!-- ===============================
 üìÅ Upload de fichiers
================================ -->
<mat-card class="mt-4 el-card-upload-file" *ngIf="activeSource === 'file'">
    <mat-card-title>Importer un fichier</mat-card-title>


    <div class="mt-2" *ngIf="showMappingForFile">
        <button mat-stroked-button color="primary" (click)="downloadTemplate('csv')">
            T√©l√©charger le mod√®le CSV
        </button>
        <button mat-stroked-button color="primary" class="ml-2" (click)="downloadTemplate('xlsx')">
            T√©l√©charger le mod√®le Excel
        </button>
    </div>

    <div class="file-upload-wrapper">
        <p-fileUpload name="file" mode="basic" chooseLabel="Choisir un fichier" [customUpload]="true"
            (onSelect)="onProductFileSelect($event)">
        </p-fileUpload>

        <span class="file-name" *ngIf="productFile">
            {{ productFile.name }}
        </span>
        <!-- Bouton Upload -->
        <button mat-raised-button color="primary" [disabled]="!productFile" (click)="uploadProducts()">
            Uploader
        </button>
    </div>


    <!-- üëá AJOUTER √Ä PARTIR D‚ÄôICI -->
    <div *ngIf="showMappingForFile" class="mapping-zone">

        <div class="mapping-group" *ngFor="let group of standardColumnGroups">
            <h3>{{ group.label }}</h3>

            <div class="mapping-grid">
                <div class="mapping-row" *ngFor="let col of group.columns">
                    <div class="left">
                        {{ col.label }}
                        <span *ngIf="col.required" class="required">*</span>
                    </div>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-select [(ngModel)]="mapping[col.key]" (selectionChange)="onMappingChange()">
                            <mat-option [value]="null">
                                ‚Äî Non mapp√© ‚Äî
                            </mat-option>

                            <mat-option *ngFor="let fileCol of fileColumns" [value]="fileCol"
                                [disabled]="isColumnAlreadyUsed(fileCol, col.key)">
                                {{ fileCol }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
        </div>

    </div>

    <!-- Bouton upload visible uniquement si le mapping est valide -->
    <div *ngIf="isMappingValid" class="mt-2">
        <button pButton type="button" label="Uploader les produits" icon="pi pi-upload"
            class="p-button-raised p-button-success" (click)="uploadProducts()">
        </button>
    </div>


    <!-- ===============================
     üëÅÔ∏è Aper√ßu des donn√©es
    ================================ -->
    <div *ngIf="previewRows.length" class="preview-zone">

        <h3>Aper√ßu des donn√©es ({{ previewRows.length }} lignes)</h3>

        <div class="preview-table">
            <table>
                <thead>
                    <tr>
                        <th *ngFor="let col of fileColumns">{{ col }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let row of previewRows">
                        <td *ngFor="let col of fileColumns">
                            {{ row[col] }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</mat-card>
<!-- ===============================
 ‚úçÔ∏è Texte manuel
================================ -->
<mat-card class="mt-4 el-card-text-manuel" *ngIf="activeSource === 'manual'">
    <mat-card-title>Texte manuel</mat-card-title>

    <form #textManuelForm="ngForm" (ngSubmit)="onTextManuelSubmit(textManuelForm)">

        <mat-form-field appearance="outline" class="w-100">
            <mat-label>Titre</mat-label>
            <input matInput name="title" ngModel required maxlength="255" placeholder="Ex: Nos coordonn√©es">
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-100">
            <mat-label>Contenu</mat-label>
            <textarea matInput name="content" ngModel required minlength="20" rows="4"
                placeholder="Ex: Contactez-nous √† info@domaine.com">
            </textarea>
        </mat-form-field>

        <button mat-raised-button color="primary" type="submit" [disabled]="textManuelForm.invalid || loading">
            Ajouter √† la base IA
        </button>

    </form>
</mat-card>